# üöÄ Fetcha Weather - Deployment Guide
**Version:** v1.0 ‚Ä¢ Updated: 2025-10-31 AEST (Brisbane)

---

## üìã Overview

This guide covers deploying Fetcha Weather to production using Railway. The deployment includes:
- Backend API (Flask + Gunicorn)
- Frontend static files
- PostgreSQL database
- Environment configuration

---

## üéØ Pre-Deployment Checklist

### Required Accounts
- [ ] Railway account (https://railway.app). I have set up an account, tell me what you need. 
- [ ] Domain name registered (fetchaweather.com). I have registered the domain name fetcha.net. I want to know if we can use this domain for various website. Could this website be fetcha.weather? 
- [ ] GitHub repository (for Railway auto-deploy) Here is the repo: git@github.com:Will954633/fetcha.weather.git

### Required Secrets
Generate secure keys using Python:
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

You'll need:
- [ ] SECRET_KEY (Flask)
- [ ] JWT_SECRET_KEY (Authentication)
- [ ] Database credentials (auto-generated by Railway)

---

## üõ†Ô∏è Step 1: Railway Setup

### 1.1 Install Railway CLI
```bash
npm install -g @railway/cli
```

### 1.2 Login to Railway
```bash
railway login
```

### 1.3 Initialize Project
```bash
cd 03_Website
railway init
```

Choose:
- Project name: `fetcha-weather-api`
- Environment: `production`

---

## üìä Step 2: Database Setup

### 2.1 Add PostgreSQL
In Railway dashboard:
1. Click "New" ‚Üí "Database" ‚Üí "PostgreSQL"
2. Wait for provisioning (2-3 minutes)
3. Note the connection string from "Connect" tab

### 2.2 Database Migration
Railway will automatically set `DATABASE_URL`. Initialize the database:

```bash
# This will run on first deployment
cd backend
python database/init_db.py
```

---

## ‚öôÔ∏è Step 3: Environment Variables

### 3.1 Set Required Variables
In Railway dashboard ‚Üí Variables tab:

```bash
# Flask Configuration
FLASK_ENV=production
SECRET_KEY=<your-generated-secret-key>
JWT_SECRET_KEY=<your-generated-jwt-secret>

# CORS (update with your actual domain)
ALLOWED_ORIGINS=https://fetchaweather.com,https://www.fetchaweather.com,https://api.fetchaweather.com

# Server
PORT=5000
PYTHONUNBUFFERED=1

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/app.log

# Database (auto-set by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}
```

### 3.2 Optional Variables (Phase 2)
```bash
# Email (SendGrid)
EMAIL_SERVICE=sendgrid
EMAIL_API_KEY=<your-sendgrid-key>
FROM_EMAIL=noreply@fetchaweather.com

# Stripe (for billing)
STRIPE_SECRET_KEY=<your-stripe-secret>
STRIPE_PUBLISHABLE_KEY=<your-stripe-publishable>
STRIPE_WEBHOOK_SECRET=<your-webhook-secret>
```

---

## üöÇ Step 4: Deploy Backend

### 4.1 Deploy via Railway CLI
```bash
railway up
```

Or push to GitHub and Railway will auto-deploy.

### 4.2 Verify Deployment
Check health endpoint:
```bash
curl https://your-app.railway.app/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-31T16:00:00+10:00",
  "version": "1.0.0"
}
```

### 4.3 Check Logs
```bash
railway logs
```

---

## üåê Step 5: Domain Configuration

### 5.1 Add Custom Domain
In Railway dashboard:
1. Go to Settings ‚Üí Domains
2. Click "Add Domain"
3. Enter: `api.fetchaweather.com`
4. Railway provides DNS instructions

### 5.2 DNS Configuration
Add these records to your DNS provider:

```
Type: CNAME
Name: api
Value: <your-app>.railway.app
TTL: 3600
```

### 5.3 SSL Certificate
Railway automatically provisions SSL certificates via Let's Encrypt.
Wait 5-10 minutes for certificate generation.

---

## üìÅ Step 6: Frontend Deployment

### Option A: Railway Static Site

1. Create new Railway project for frontend
2. Set build command:
```bash
echo "No build needed"
```
3. Set root directory: `03_Website/frontend`
4. Deploy

### Option B: Netlify/Vercel (Recommended)

**Netlify:**
```bash
cd 03_Website/frontend
netlify deploy --prod
```

**Vercel:**
```bash
cd 03_Website/frontend
vercel --prod
```

### Frontend DNS
```
Type: CNAME
Name: www
Value: <netlify-or-vercel-domain>

Type: CNAME
Name: @
Value: <netlify-or-vercel-domain>
```

---

## ‚úÖ Step 7: Post-Deployment Verification

### 7.1 Test API Endpoints

**Health Check:**
```bash
curl https://api.fetchaweather.com/health
```

**API Info:**
```bash
curl https://api.fetchaweather.com/api
```

**User Registration:**
```bash
curl -X POST https://api.fetchaweather.com/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPassword123!",
    "name": "Test User"
  }'
```

### 7.2 Test Frontend
1. Visit https://fetchaweather.com
2. Click "Sign Up"
3. Create account
4. Generate API key
5. Test weather endpoint

### 7.3 Monitor Performance
```bash
# Check response times
curl -w "@curl-format.txt" -o /dev/null -s https://api.fetchaweather.com/health
```

Create `curl-format.txt`:
```
time_namelookup:  %{time_namelookup}\n
time_connect:  %{time_connect}\n
time_appconnect:  %{time_appconnect}\n
time_pretransfer:  %{time_pretransfer}\n
time_redirect:  %{time_redirect}\n
time_starttransfer:  %{time_starttransfer}\n
----------\n
time_total:  %{time_total}\n
```

---

## üîß Step 8: Production Configuration

### 8.1 Enable Production Mode
Verify environment variables:
```bash
railway variables
```

Ensure `FLASK_ENV=production`

### 8.2 Database Backups
Railway automatically backs up PostgreSQL daily.

Manual backup:
```bash
railway run pg_dump $DATABASE_URL > backup.sql
```

### 8.3 Logging
View logs in real-time:
```bash
railway logs --follow
```

---

## üìä Step 9: Monitoring Setup (Optional)

### 9.1 Railway Metrics
Railway provides built-in metrics:
- CPU usage
- Memory usage
- Network traffic
- Response times

### 9.2 External Monitoring

**Sentry (Error Tracking):**
1. Create Sentry account
2. Add to environment variables:
```bash
SENTRY_DSN=<your-sentry-dsn>
```

**UptimeRobot (Uptime Monitoring):**
1. Create monitor for `https://api.fetchaweather.com/health`
2. Set check interval: 5 minutes
3. Add email/SMS alerts

---

## üîÑ Step 10: CI/CD Setup

### 10.1 GitHub Actions (Optional)
Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Railway

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Railway
        run: npm install -g @railway/cli
      - name: Deploy
        run: railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

### 10.2 Auto-Deploy
Railway automatically deploys on git push if connected to GitHub.

---

## üö® Troubleshooting

### Common Issues

**502 Bad Gateway:**
- Check if app is running: `railway logs`
- Verify PORT environment variable
- Check database connection

**Database Connection Failed:**
- Verify DATABASE_URL is set
- Check PostgreSQL is running
- Run database init: `railway run python backend/database/init_db.py`

**CORS Errors:**
- Update ALLOWED_ORIGINS with production domains
- Check frontend is using correct API URL

**Slow Response Times:**
- Check database indexes
- Review query performance
- Consider adding Redis cache

---

## üìà Scaling

### Horizontal Scaling
Railway Pro plan allows:
- Multiple replicas
- Auto-scaling based on CPU/memory
- Custom regions

### Database Scaling
- Upgrade PostgreSQL plan in Railway
- Add read replicas for heavy read workloads
- Consider connection pooling

---

## üîê Security Checklist

- [ ] HTTPS enabled (Railway auto-provisions)
- [ ] Strong SECRET_KEY and JWT_SECRET_KEY
- [ ] Database credentials secured
- [ ] CORS properly configured
- [ ] API rate limiting enabled (Phase 2)
- [ ] Input validation on all endpoints
- [ ] SQL injection prevention (using ORM)
- [ ] XSS protection enabled
- [ ] Security headers configured

---

## üí∞ Cost Estimation

### Railway Costs (Monthly)
- Starter (Free): $0
  - 512 MB RAM
  - Shared CPU
  - Limited hours
  
- Developer ($5/month):
  - 8 GB RAM
  - Shared CPU
  - Unlimited hours
  
- Pro ($20/month):
  - 32 GB RAM
  - Dedicated CPU
  - Auto-scaling

### Database Costs
- Starter PostgreSQL: $5/month
  - 1 GB storage
  - 100 connections

- Pro PostgreSQL: $15/month
  - 10 GB storage
  - 400 connections

**Recommended for Phase 1:** Developer + Starter PostgreSQL = $10/month

---

## üìû Support

### Issues
- Railway: https://railway.app/help
- GitHub Issues: Create issue in repository
- Email: hello@fetchaweather.com

### Documentation
- Railway Docs: https://docs.railway.app
- Flask Docs: https://flask.palletsprojects.com
- This Guide: `03_Website/DEPLOYMENT_GUIDE.md`

---

## ‚úÖ Deployment Complete!

Your Fetcha Weather API should now be live at:
- API: https://api.fetchaweather.com
- Frontend: https://fetchaweather.com
- Dashboard: https://fetchaweather.com/dashboard.html

Next steps:
1. Test all functionality
2. Monitor logs for errors
3. Set up backups
4. Configure monitoring
5. Plan for Phase 2 (Stripe integration)
